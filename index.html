<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PurposeMobile Tools - Unified Field Calculator</title>
    <meta name="description" content="Professional construction calculator for field use - Pipe Level Check, Laser, Regrade & Grade Check tools">
    <meta name="theme-color" content="#006699">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Field Tools">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Application CSS -->
    <link rel="stylesheet" href="variables.css">
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="components.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app">
        <!-- Unified Header -->
        <header class="unified-header">
            <h1><i class="fas fa-calculator"></i> Field Tools</h1>
            <p class="subtitle">Pipe Level Check • Laser • Regrade • Grade Check • Chainage IL • Notes</p>
            
            <div class="header-controls">
                <div class="project-info">
                    <input type="text" class="project-input" id="unifiedProjectName" placeholder="Project Name">
                    <input type="text" class="project-input" id="unifiedStage" placeholder="Stage">
                </div>
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <button class="header-btn" id="loginBtn" onclick="showAuthModal('login')">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login</span>
                    </button>
                    <button class="header-btn hidden" id="logoutBtn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                    <span class="user-email hidden" id="userEmail"></span>
                    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="pipelevelcheck">
                <i class="fas fa-ruler-combined"></i>
                <span>Pipe Level</span>
            </button>
            <button class="tab-btn" data-tab="laser">
                <i class="fas fa-bullseye"></i>
                <span>Laser</span>
            </button>
            <button class="tab-btn" data-tab="regrade">
                <i class="fas fa-exchange-alt"></i>
                <span>Regrade</span>
            </button>
            <button class="tab-btn" data-tab="gradecheck">
                <i class="fas fa-check-double"></i>
                <span>Grade Check</span>
            </button>
            <button class="tab-btn" data-tab="chainageil">
                <i class="fas fa-map-marker-alt"></i>
                <span>Chainage IL</span>
            </button>
            <button class="tab-btn" data-tab="generalnotes">
                <i class="fas fa-sticky-note"></i>
                <span>Notes</span>
            </button>
        </nav>

        <!-- Pipe Level Check Tab -->
        <div id="pipelevelcheck-tab" class="tab-content active">
            <div class="main-content">
                <div class="section-header collapsed" onclick="toggleSection('pipeLevelCheckSection', event)">
                    <i class="fas fa-ruler-combined"></i>
                    <span>Pipe Level Check Calculations</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="section-content collapsed" id="pipeLevelCheckSection">
                    <div class="section-inner">
                        <div id="pipeLevelCheckReadingsContainer"></div>
                        
                        <button class="btn btn-primary" id="addPipeLevelCheckReadingBtn">
                            <i class="fas fa-plus"></i>
                            Add Pipe Level Check
                        </button>

                        <button class="btn btn-warning clear-tool-btn" onclick="clearPipeLevelCheckToolData()">
                            <i class="fas fa-broom"></i>
                            Clear Pipe Level Data
                        </button>
                    </div>
                </div>

                <!-- Quick Guide Grade Table -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('pipeLevelGradeTable', event)">
                        <i class="fas fa-table"></i>
                        <span>Quick Guide Grade Table</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="pipeLevelGradeTable">
                        <table class="grade-table">
                            <thead>
                                <tr>
                                    <th>Ratio</th>
                                    <th>%</th>
                                    <th>1m Rise</th>
                                    <th>6m Rise</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1:40</td><td>2.500</td><td>25mm</td><td>150mm</td></tr>
                                <tr><td>1:45</td><td>2.222</td><td>22mm</td><td>133mm</td></tr>
                                <tr><td>1:50</td><td>2.000</td><td>20mm</td><td>120mm</td></tr>
                                <tr><td>1:55</td><td>1.818</td><td>18mm</td><td>109mm</td></tr>
                                <tr><td>1:60</td><td>1.667</td><td>17mm</td><td>100mm</td></tr>
                                <tr><td>1:65</td><td>1.538</td><td>15mm</td><td>92mm</td></tr>
                                <tr><td>1:70</td><td>1.429</td><td>14mm</td><td>86mm</td></tr>
                                <tr><td>1:75</td><td>1.333</td><td>13mm</td><td>80mm</td></tr>
                                <tr><td>1:80</td><td>1.250</td><td>13mm</td><td>75mm</td></tr>
                                <tr><td>1:85</td><td>1.176</td><td>12mm</td><td>71mm</td></tr>
                                <tr><td>1:90</td><td>1.111</td><td>11mm</td><td>67mm</td></tr>
                                <tr><td>1:95</td><td>1.053</td><td>11mm</td><td>63mm</td></tr>
                                <tr><td>1:100</td><td>1.000</td><td>10mm</td><td>60mm</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Valuations Section -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('pipeLevelValuations', event)">
                        <i class="fas fa-info-circle"></i>
                        <span>Tool Valuations - Pipe Level Check</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="pipeLevelValuations">
                        <div class="formula-display">
                            <div class="formula-title">1. PIPE LEVEL CHECK</div>
                            <div class="formula-step"><strong>Purpose:</strong> Verify installed pipe levels match design specifications.</div>
                            <div class="formula-step"><strong>When to Use:</strong> After laying each pipe section to confirm it meets design grade.</div>
                            <br>
                            <div class="formula-step"><strong>Steps:</strong></div>
                            <div class="formula-step">1. Enter the design slope (e.g., 1.111% or 1 in 90)</div>
                            <div class="formula-step">2. Enter horizontal distance from start point (e.g., 25.00m)</div>
                            <div class="formula-step">3. Enter the start height/IL (e.g., 179.250m)</div>
                            <div class="formula-step">4. Enter the measured height at end point (e.g., 179.730m)</div>
                            <br>
                            <div class="formula-step"><strong>Math:</strong></div>
                            <div class="formula-step">• Rise per meter = 1.111% ÷ 100 = 0.01111 m/m</div>
                            <div class="formula-step">• Design height = 179.250 + (25.00 × 0.01111) = 179.528m</div>
                            <div class="formula-step">• Difference = 179.730 - 179.528 = 0.202m</div>
                            <div class="formula-step">• Result: HIGH +0.202m (pipe is 202mm too high)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Laser Converter Tab -->
        <div id="laser-tab" class="tab-content">
            <div class="main-content">
                <!-- Laser Conversions Section -->
                <div class="section-header collapsed" onclick="toggleSection('laserConversionsSection', event)">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Laser Grade Conversions</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="section-content collapsed" id="laserConversionsSection">
                    <div class="section-inner">
                        <div id="laserReadingsContainer"></div>
                        
                        <button class="btn btn-primary" id="addLaserReadingBtn">
                            <i class="fas fa-plus"></i>
                            Add Conversion
                        </button>

                        <button class="btn btn-warning clear-tool-btn" onclick="clearLaserToolData()">
                            <i class="fas fa-broom"></i>
                            Clear Laser Data
                        </button>
                    </div>
                </div>

                <!-- Reference Table -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('laserReference', event)">
                        <i class="fas fa-table"></i>
                        <span>Grade Reference Table</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="laserReference">
                        <table class="grade-table">
                            <thead>
                                <tr>
                                    <th>Ratio</th>
                                    <th>Laser %</th>
                                    <th>1m Rise</th>
                                    <th>6m Rise</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1:40</td><td>2.5000</td><td>25mm</td><td>150mm</td></tr>
                                <tr><td>1:45</td><td>2.2222</td><td>22mm</td><td>133mm</td></tr>
                                <tr><td>1:50</td><td>2.0000</td><td>20mm</td><td>120mm</td></tr>
                                <tr><td>1:60</td><td>1.6667</td><td>17mm</td><td>100mm</td></tr>
                                <tr><td>1:70</td><td>1.4286</td><td>14mm</td><td>86mm</td></tr>
                                <tr><td>1:80</td><td>1.2500</td><td>13mm</td><td>75mm</td></tr>
                                <tr><td>1:90</td><td>1.1111</td><td>11mm</td><td>67mm</td></tr>
                                <tr><td>1:100</td><td>1.0000</td><td>10mm</td><td>60mm</td></tr>
                                <tr><td>1:120</td><td>0.8333</td><td>8mm</td><td>50mm</td></tr>
                                <tr><td>1:150</td><td>0.6667</td><td>7mm</td><td>40mm</td></tr>
                                <tr><td>1:200</td><td>0.5000</td><td>5mm</td><td>30mm</td></tr>
                                <tr><td>1:300</td><td>0.3333</td><td>3mm</td><td>20mm</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Valuations Section -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('laserValuations', event)">
                        <i class="fas fa-info-circle"></i>
                        <span>Tool Valuations - Laser Converter</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="laserValuations">
                        <div class="formula-display">
                            <div class="formula-title">2. LASER CONVERTER</div>
                            <div class="formula-step"><strong>Purpose:</strong> Convert between grade ratios and laser level percentages for equipment setup.</div>
                            <div class="formula-step"><strong>When to Use:</strong> Setting up rotating laser levels that require percentage input instead of ratio.</div>
                            <br>
                            <div class="formula-step"><strong>Steps:</strong></div>
                            <div class="formula-step">1. Enter either the grade ratio (e.g., 90) OR the laser percentage (e.g., 1.1111%)</div>
                            <div class="formula-step">2. Tool automatically calculates the other value</div>
                            <br>
                            <div class="formula-step"><strong>Math:</strong></div>
                            <div class="formula-step">• Given ratio: 1 in 90</div>
                            <div class="formula-step">• Laser % = 100 ÷ 90 = 1.1111%</div>
                            <div class="formula-step">OR</div>
                            <div class="formula-step">• Given laser: 1.1111%</div>
                            <div class="formula-step">• Ratio = 100 ÷ 1.1111 = 90 (1 in 90)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Regrade Tool Tab -->
        <div id="regrade-tab" class="tab-content">
            <div class="main-content">
                <!-- Regrade Calculations Section -->
                <div class="section-header collapsed" onclick="toggleSection('regradeCalculationsSection', event)">
                    <i class="fas fa-calculator"></i>
                    <span>Regrade Calculations</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="section-content collapsed" id="regradeCalculationsSection">
                    <div class="section-inner">
                        <div id="regradeReadingsContainer"></div>

                        <button class="btn btn-primary" id="addRegradeReadingBtn">
                            <i class="fas fa-plus-circle"></i>
                            Add Regrade Calculation
                        </button>

                        <button class="btn btn-warning clear-tool-btn" onclick="clearRegradeToolData()">
                            <i class="fas fa-broom"></i>
                            Clear Regrade Data
                        </button>
                    </div>
                </div>

                <!-- Quick Guide Grade Table -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('regradeGradeTable', event)">
                        <i class="fas fa-table"></i>
                        <span>Quick Guide Grade Table</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="regradeGradeTable">
                        <table class="grade-table">
                            <thead>
                                <tr>
                                    <th>Ratio</th>
                                    <th>%</th>
                                    <th>1m Rise</th>
                                    <th>6m Rise</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1:40</td><td>2.500</td><td>25mm</td><td>150mm</td></tr>
                                <tr><td>1:45</td><td>2.222</td><td>22mm</td><td>133mm</td></tr>
                                <tr><td>1:50</td><td>2.000</td><td>20mm</td><td>120mm</td></tr>
                                <tr><td>1:55</td><td>1.818</td><td>18mm</td><td>109mm</td></tr>
                                <tr><td>1:60</td><td>1.667</td><td>17mm</td><td>100mm</td></tr>
                                <tr><td>1:65</td><td>1.538</td><td>15mm</td><td>92mm</td></tr>
                                <tr><td>1:70</td><td>1.429</td><td>14mm</td><td>86mm</td></tr>
                                <tr><td>1:75</td><td>1.333</td><td>13mm</td><td>80mm</td></tr>
                                <tr><td>1:80</td><td>1.250</td><td>13mm</td><td>75mm</td></tr>
                                <tr><td>1:85</td><td>1.176</td><td>12mm</td><td>71mm</td></tr>
                                <tr><td>1:90</td><td>1.111</td><td>11mm</td><td>67mm</td></tr>
                                <tr><td>1:95</td><td>1.053</td><td>11mm</td><td>63mm</td></tr>
                                <tr><td>1:100</td><td>1.000</td><td>10mm</td><td>60mm</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Valuations Section -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('regradeValuations', event)">
                        <i class="fas fa-info-circle"></i>
                        <span>Tool Valuations - Regrade Tool</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="regradeValuations">
                        <div class="formula-display">
                            <div class="formula-title">3. REGRADE TOOL</div>
                            <div class="formula-step"><strong>Purpose:</strong> Calculate what new grade is needed to reach a target level from current position.</div>
                            <div class="formula-step"><strong>When to Use:</strong> When installed pipe is off-level and you need to determine the corrected grade to get back on track.</div>
                            <br>
                            <div class="formula-step"><strong>Steps:</strong></div>
                            <div class="formula-step">1. Enter current grade (e.g., 1.111% or 1 in 90)</div>
                            <div class="formula-step">2. Enter horizontal distance to target (e.g., 30.00m)</div>
                            <div class="formula-step">3. Enter current pipe IL (e.g., 179.250m)</div>
                            <div class="formula-step">4. Enter target IL you need to reach (e.g., 179.650m)</div>
                            <br>
                            <div class="formula-step"><strong>Math:</strong></div>
                            <div class="formula-step">• Height difference = 179.650 - 179.250 = 0.400m</div>
                            <div class="formula-step">• New grade % = (0.400 ÷ 30.00) × 100 = 1.333%</div>
                            <div class="formula-step">• New ratio = 100 ÷ 1.333 = 75 (1 in 75)</div>
                            <div class="formula-step">• Result: Change from 1.111% to 1.333% (1 in 90 to 1 in 75)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grade Check Tab -->
        <div id="gradecheck-tab" class="tab-content">
            <div class="main-content">
                <!-- Grade Verifications Section -->
                <div class="section-header collapsed" onclick="toggleSection('gradeCheckVerifications', event)">
                    <i class="fas fa-check-double"></i>
                    <span>Grade Verifications</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="section-content collapsed" id="gradeCheckVerifications">
                    <div class="section-inner">
                        <div id="gradeCheckReadingsContainer"></div>

                        <button class="btn btn-secondary" id="addGradeCheckReadingBtn">
                            <i class="fas fa-plus-circle"></i>
                            Add Verification Section
                        </button>

                        <button class="btn btn-warning clear-tool-btn" onclick="clearGradeCheckToolData()">
                            <i class="fas fa-broom"></i>
                            Clear Grade Check Data
                        </button>
                    </div>
                </div>

                <!-- Quick Guide Grade Table -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('gradeCheckGradeTable', event)">
                        <i class="fas fa-table"></i>
                        <span>Quick Guide Grade Table</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="gradeCheckGradeTable">
                        <table class="grade-table">
                            <thead>
                                <tr>
                                    <th>Ratio</th>
                                    <th>%</th>
                                    <th>1m Rise</th>
                                    <th>6m Rise</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1:40</td><td>2.500</td><td>25mm</td><td>150mm</td></tr>
                                <tr><td>1:45</td><td>2.222</td><td>22mm</td><td>133mm</td></tr>
                                <tr><td>1:50</td><td>2.000</td><td>20mm</td><td>120mm</td></tr>
                                <tr><td>1:55</td><td>1.818</td><td>18mm</td><td>109mm</td></tr>
                                <tr><td>1:60</td><td>1.667</td><td>17mm</td><td>100mm</td></tr>
                                <tr><td>1:65</td><td>1.538</td><td>15mm</td><td>92mm</td></tr>
                                <tr><td>1:70</td><td>1.429</td><td>14mm</td><td>86mm</td></tr>
                                <tr><td>1:75</td><td>1.333</td><td>13mm</td><td>80mm</td></tr>
                                <tr><td>1:80</td><td>1.250</td><td>13mm</td><td>75mm</td></tr>
                                <tr><td>1:85</td><td>1.176</td><td>12mm</td><td>71mm</td></tr>
                                <tr><td>1:90</td><td>1.111</td><td>11mm</td><td>67mm</td></tr>
                                <tr><td>1:95</td><td>1.053</td><td>11mm</td><td>63mm</td></tr>
                                <tr><td>1:100</td><td>1.000</td><td>10mm</td><td>60mm</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Valuations Section -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('gradeCheckValuations', event)">
                        <i class="fas fa-info-circle"></i>
                        <span>Tool Valuations - Grade Check</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="gradeCheckValuations">
                        <div class="formula-display">
                            <div class="formula-title">4. GRADE CHECK</div>
                            <div class="formula-step"><strong>Purpose:</strong> Compare as-constructed grade against design grade to verify compliance.</div>
                            <div class="formula-step"><strong>When to Use:</strong> After completing a pipe section to document actual vs design performance.</div>
                            <br>
                            <div class="formula-step"><strong>Steps:</strong></div>
                            <div class="formula-step">1. Enter downstream IL (e.g., 179.250m)</div>
                            <div class="formula-step">2. Enter upstream IL (e.g., 179.730m)</div>
                            <div class="formula-step">3. Enter pipe length (e.g., 43.18m)</div>
                            <div class="formula-step">4. Enter design grade (e.g., 1.111% or 1 in 90)</div>
                            <br>
                            <div class="formula-step"><strong>Math:</strong></div>
                            <div class="formula-step">• Design rise = 43.18 × (1.111 ÷ 100) = 0.480m</div>
                            <div class="formula-step">• Design rise/meter = (0.480 ÷ 43.18) × 1000 = 11.11mm/m</div>
                            <div class="formula-step">• Actual rise = 179.730 - 179.250 = 0.480m</div>
                            <div class="formula-step">• Actual grade % = (0.480 ÷ 43.18) × 100 = 1.111%</div>
                            <div class="formula-step">• Actual rise/meter = (0.480 ÷ 43.18) × 1000 = 11.11mm/m</div>
                            <div class="formula-step">• Result: MATCH - Design and as-constructed are identical</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chainage IL Tab -->
        <div id="chainageil-tab" class="tab-content">
            <div class="main-content">
                <!-- Chainage IL Calculations Section -->
                <div class="section-header collapsed" onclick="toggleSection('chainageILSection', event)">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Chainage IL Calculations</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="section-content collapsed" id="chainageILSection">
                    <div class="section-inner">
                        <div id="chainageILReadingsContainer"></div>
                        
                        <button class="btn btn-primary" id="addChainageILReadingBtn">
                            <i class="fas fa-plus"></i>
                            Add Chainage Calculation
                        </button>

                        <button class="btn btn-warning clear-tool-btn" onclick="clearChainageILToolData()">
                            <i class="fas fa-broom"></i>
                            Clear Chainage Data
                        </button>
                    </div>
                </div>

                <!-- Reference Table -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('chainageILReference', event)">
                        <i class="fas fa-table"></i>
                        <span>Quick Grade Reference</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="chainageILReference">
                        <table class="grade-table">
                            <thead>
                                <tr>
                                    <th>Ratio</th>
                                    <th>%</th>
                                    <th>1m Rise</th>
                                    <th>6m Rise</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1:40</td><td>2.500</td><td>25mm</td><td>150mm</td></tr>
                                <tr><td>1:45</td><td>2.222</td><td>22mm</td><td>133mm</td></tr>
                                <tr><td>1:50</td><td>2.000</td><td>20mm</td><td>120mm</td></tr>
                                <tr><td>1:55</td><td>1.818</td><td>18mm</td><td>109mm</td></tr>
                                <tr><td>1:60</td><td>1.667</td><td>17mm</td><td>100mm</td></tr>
                                <tr><td>1:65</td><td>1.538</td><td>15mm</td><td>92mm</td></tr>
                                <tr><td>1:70</td><td>1.429</td><td>14mm</td><td>86mm</td></tr>
                                <tr><td>1:75</td><td>1.333</td><td>13mm</td><td>80mm</td></tr>
                                <tr><td>1:80</td><td>1.250</td><td>13mm</td><td>75mm</td></tr>
                                <tr><td>1:85</td><td>1.176</td><td>12mm</td><td>71mm</td></tr>
                                <tr><td>1:90</td><td>1.111</td><td>11mm</td><td>67mm</td></tr>
                                <tr><td>1:95</td><td>1.053</td><td>11mm</td><td>63mm</td></tr>
                                <tr><td>1:100</td><td>1.000</td><td>10mm</td><td>60mm</td></tr>
                                <tr><td>1:110</td><td>0.909</td><td>9mm</td><td>55mm</td></tr>
                                <tr><td>1:120</td><td>0.833</td><td>8mm</td><td>50mm</td></tr>
                                <tr><td>1:130</td><td>0.769</td><td>8mm</td><td>46mm</td></tr>
                                <tr><td>1:140</td><td>0.714</td><td>7mm</td><td>43mm</td></tr>
                                <tr><td>1:150</td><td>0.667</td><td>7mm</td><td>40mm</td></tr>
                                <tr><td>1:160</td><td>0.625</td><td>6mm</td><td>38mm</td></tr>
                                <tr><td>1:180</td><td>0.556</td><td>6mm</td><td>33mm</td></tr>
                                <tr><td>1:200</td><td>0.500</td><td>5mm</td><td>30mm</td></tr>
                                <tr><td>1:250</td><td>0.400</td><td>4mm</td><td>24mm</td></tr>
                                <tr><td>1:300</td><td>0.333</td><td>3mm</td><td>20mm</td></tr>
                                <tr><td>1:400</td><td>0.250</td><td>3mm</td><td>15mm</td></tr>
                                <tr><td>1:500</td><td>0.200</td><td>2mm</td><td>12mm</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Valuations Section -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('chainageValuations', event)">
                        <i class="fas fa-info-circle"></i>
                        <span>Tool Valuations - Chainage IL</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="chainageValuations">
                        <div class="formula-display">
                            <div class="formula-title">5. CHAINAGE IL (IL AT CHAINAGE)</div>
                            <div class="formula-step"><strong>Purpose:</strong> Calculate the design invert level at any point along the pipeline.</div>
                            <div class="formula-step"><strong>When to Use:</strong> When you need to know what the design IL should be at an intermediate chainage for setout or checking.</div>
                            <br>
                            <div class="formula-step"><strong>Steps:</strong></div>
                            <div class="formula-step">1. Enter the start IL (e.g., 179.250m)</div>
                            <div class="formula-step">2. Enter the chainage/distance from start (e.g., 20.00m)</div>
                            <div class="formula-step">3. Enter the design grade (e.g., 1.111% or 1 in 90)</div>
                            <br>
                            <div class="formula-step"><strong>Math:</strong></div>
                            <div class="formula-step">• Rise per meter = 1.111 ÷ 100 = 0.01111 m/m</div>
                            <div class="formula-step">• Total rise = 0.01111 × 20.00 = 0.222m</div>
                            <div class="formula-step">• IL at chainage = 179.250 + 0.222 = 179.472m</div>
                            <div class="formula-step">• Result: IL at CH 20.00 = 179.472m</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- General Notes Tab -->
        <div id="generalnotes-tab" class="tab-content">
            <div class="main-content">
                <!-- General Notes Section -->
                <div class="section-header collapsed" onclick="toggleSection('generalNotesSection', event)">
                    <i class="fas fa-sticky-note"></i>
                    <span>General Notes</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="section-content collapsed" id="generalNotesSection">
                    <div class="section-inner">
                        <div id="generalNotesContainer"></div>
                        
                        <button class="btn btn-primary" id="addGeneralNoteBtn">
                            <i class="fas fa-plus"></i>
                            Add Note
                        </button>

                        <button class="btn btn-warning clear-tool-btn" onclick="clearGeneralNotesData()">
                            <i class="fas fa-broom"></i>
                            Clear All Notes
                        </button>
                    </div>
                </div>

                <!-- Valuations Section -->
                <div class="reference-section">
                    <div class="reference-header collapsed" onclick="toggleReferenceTable('notesValuations', event)">
                        <i class="fas fa-info-circle"></i>
                        <span>Tool Valuations - General Notes</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="reference-content collapsed" id="notesValuations">
                        <div class="formula-display">
                            <div class="formula-title">General Notes Purpose:</div>
                            <div class="formula-step">• Document field observations and conditions</div>
                            <div class="formula-step">• Record construction progress and issues</div>
                            <div class="formula-step">• Essential for comprehensive project documentation</div>
                            <br>
                            <div class="formula-title">Field Applications:</div>
                            <div class="formula-step">• Daily site diary and observations</div>
                            <div class="formula-step">• Construction progress recording</div>
                            <div class="formula-step">• Issue tracking and resolution documentation</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unified Message Preview Section -->
        <div class="main-content">
            <div class="section-header" onclick="toggleSection('unifiedPreviewSection', event)">
                <i class="fas fa-file-alt"></i>
                <span>Unified Report Message</span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="section-content" id="unifiedPreviewSection">
                <div class="section-inner">
                    <div class="preview-container">
                        <div class="preview-label">
                            <i class="fas fa-comment-dots"></i>
                            Combined Field Report
                        </div>
                        <textarea 
                            class="preview-textarea" 
                            id="unifiedPreviewText" 
                            placeholder="Enter project information and add calculations to generate report..."
                            oninput="handleUnifiedPreviewEdit()"
                        ></textarea>
                        <div class="format-warning hidden" id="unifiedFormatWarning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Manual edits will be overwritten when calculations change
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="copyUnifiedMessage()">
                            <i class="fas fa-copy"></i>
                            Copy Report
                        </button>
                        <button class="btn btn-primary" onclick="saveCurrentReport()">
                            <i class="fas fa-save"></i>
                            Save Report
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i>
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" id="notificationIcon"></i>
        <span id="notificationText">Operation completed</span>
    </div>
    
    <!-- Application JavaScript (ES6 Modules) -->
    <script type="module" src="app.js"></script>
    
    <!-- Firebase Integration Script -->
    <script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDIW7Sd8A2Hj6WCcTOBKFMicthdCigORKQ",
        authDomain: "purposemobile-field-tools.firebaseapp.com",
        projectId: "purposemobile-field-tools",
        storageBucket: "purposemobile-field-tools.firebasestorage.app",
        messagingSenderId: "891906440026",
        appId: "1:891906440026:web:03f19a5e56267e11e55163"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Auth functions
    window.showAuthModal = function(mode) {
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:2000;" id="authModalBackdrop">
                <div style="background:white;padding:30px;border-radius:12px;max-width:400px;width:90%;">
                    <h2 style="margin:0 0 20px 0;">${mode === 'signup' ? 'Sign Up' : 'Login'}</h2>
                    <input type="email" id="authEmail" placeholder="Email" style="width:100%;padding:12px;margin-bottom:12px;border:2px solid #ddd;border-radius:8px;">
                    <input type="password" id="authPassword" placeholder="Password" style="width:100%;padding:12px;margin-bottom:12px;border:2px solid #ddd;border-radius:8px;">
                    ${mode === 'signup' ? '<input type="password" id="authPasswordConfirm" placeholder="Confirm Password" style="width:100%;padding:12px;margin-bottom:12px;border:2px solid #ddd;border-radius:8px;">' : ''}
                    <button onclick="window.${mode === 'signup' ? 'doSignup' : 'doLogin'}()" style="width:100%;padding:14px;background:#006699;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">${mode === 'signup' ? 'Sign Up' : 'Login'}</button>
                    <button onclick="window.hideAuthModal()" style="width:100%;padding:14px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
                    <p style="text-align:center;margin-top:15px;font-size:0.9rem;">
                        ${mode === 'signup' ? 'Already have an account? <a href="#" onclick="window.hideAuthModal();window.showAuthModal(\'login\');return false;">Login</a>' : 'Need an account? <a href="#" onclick="window.hideAuthModal();window.showAuthModal(\'signup\');return false;">Sign Up</a>'}
                    </p>
                </div>
            </div>
        `;
        document.body.appendChild(modal.firstElementChild);
    };
    
    window.hideAuthModal = function() {
        const modal = document.getElementById('authModalBackdrop');
        if (modal) modal.remove();
    };
    
    window.doLogin = async function() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
            window.hideAuthModal();
        } catch (error) {
            alert('Login failed: ' + error.message);
        }
    };
    
    window.doSignup = async function() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const confirm = document.getElementById('authPasswordConfirm').value;
        if (password !== confirm) {
            alert('Passwords do not match');
            return;
        }
        try {
            await auth.createUserWithEmailAndPassword(email, password);
            window.hideAuthModal();
        } catch (error) {
            alert('Signup failed: ' + error.message);
        }
    };
    
    window.logout = async function() {
        try {
            await auth.signOut();
        } catch (error) {
            alert('Logout failed: ' + error.message);
        }
    };
    
    window.saveCurrentReport = async function() {
        console.log('=== SAVE REPORT STARTED ===');
        
        if (!auth.currentUser) {
            alert('Please login to save reports');
            return;
        }
        
        const projectName = document.getElementById('unifiedProjectName').value;
        const stage = document.getElementById('unifiedStage').value;
        
        if (!projectName || !stage) {
            alert('Please enter project name and stage');
            return;
        }
        
        console.log('Project:', projectName, 'Stage:', stage);
        
        try {
            // Get the unified preview text which contains all the data
            const reportText = document.getElementById('unifiedPreviewText').value;
            
            // Simple save with just the essentials
            const reportData = {
                userId: auth.currentUser.uid,
                userEmail: auth.currentUser.email,
                projectName: projectName,
                stage: stage,
                reportText: reportText,
                savedAt: new Date().toISOString()
            };
            
            console.log('Saving report data:', reportData);
            
            const docRef = await db.collection('reports').add(reportData);
            
            console.log('SUCCESS! Document ID:', docRef.id);
            alert('Report saved successfully!');
            
        } catch (error) {
            console.error('Save error:', error);
            alert('Save failed: ' + error.message);
        }
    };
    
    // Auth state listener
    auth.onAuthStateChanged(user => {
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmail = document.getElementById('userEmail');
        
        if (user) {
            if (loginBtn) loginBtn.classList.add('hidden');
            if (logoutBtn) logoutBtn.classList.remove('hidden');
            if (userEmail) {
                userEmail.textContent = user.email;
                userEmail.classList.remove('hidden');
            }
        } else {
            if (loginBtn) loginBtn.classList.remove('hidden');
            if (logoutBtn) logoutBtn.classList.add('hidden');
            if (userEmail) userEmail.classList.add('hidden');
        }
    });
    </script>
</body>
</html>
